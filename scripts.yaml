# Script for writing (dis)charge power to modbus register
# Add to HA via GUI

alias: Marstek Set Forcible Charge
description: ""
icon: mdi:battery-charging-40
sequence:
  - choose:
      - conditions:
          - condition: numeric_state
            entity_id: input_number.marstek_discharging_charging_power
            above: -1
            below: 1
        sequence:
          - data:
              hub: Marstek
              address: 42010
              slave: 1
              value: 0
            action: modbus.write_register
          - data:
              hub: Marstek
              address: 42020
              slave: 1
              value: 0
            action: modbus.write_register
          - data:
              hub: Marstek
              address: 42021
              slave: 1
              value: 0
            action: modbus.write_register
      - conditions:
          - condition: numeric_state
            entity_id: input_number.marstek_discharging_charging_power
            above: -2501
            below: -10
        sequence:
          - data:
              hub: Marstek
              address: 42021
              slave: 1
              value: >-
                {{ states('input_number.marstek_discharging_charging_power')
                | int | abs }}
            action: modbus.write_register
          - data:
              hub: Marstek
              address: 42010
              slave: 1
              value: 2
            action: modbus.write_register
      - conditions:
          - condition: numeric_state
            entity_id: input_number.marstek_discharging_charging_power
            above: 10
            below: 2501
        sequence:
          - data:
              hub: Marstek
              address: 42020
              slave: 1
              value: >-
                {{ states('input_number.marstek_discharging_charging_power')
                | int | abs }}
            action: modbus.write_register
          - data:
              hub: Marstek
              address: 42010
              slave: 1
              value: 1
            action: modbus.write_register
